name: Pub/Sub Emulator Test

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-pubsub-emulator:
    runs-on: ubuntu-latest
    container:
      image: gcr.io/google.com/cloudsdktool/cloud-sdk:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Pub/Sub Emulator in Background
        run: |
          echo "Starting Pub/Sub Emulator..."
          # Start emulator, listen on all interfaces inside the container
          # Send it to the background using '&'
          gcloud beta emulators pubsub start --project=test-project --host-port=0.0.0.0:8085 &
          # Wait for the emulator to initialize (adjust sleep time if necessary)
          sleep 10
          echo "Emulator likely started. Checking ports..."
          # Optional: Check if the port is listening (netstat might not be in cloud-sdk, try ss or nc)
          # ss -tulnp | grep 8085 || echo "Port 8085 not confirmed listening yet, proceeding anyway."
          echo "======"
          gcloud beta emulators pubsub env-init
          echo "======"

          echo "Configure gcloud and Emulator Host"
          echo "======"

          echo "Setting PUBSUB_EMULATOR_HOST for subsequent steps..."
          # The emulator is running in the same container, so connect via localhost
          echo "PUBSUB_EMULATOR_HOST=localhost:8085" >> $GITHUB_ENV
          echo "PUBSUB_PROJECT_ID=test-project" >> $GITHUB_ENV

          $(gcloud beta emulators pubsub env-init)

          # --- REMOVED THE FOLLOWING LINES ---
          # echo "Disabling gcloud credential loading for emulator usage..."
          # gcloud config set auth/disable_credentials true
          # --- END OF REMOVED LINES ---

          # Ensure the project is set (might be inherited, but explicit is safer)
          echo "Setting gcloud project..."
          gcloud config set project test-project

          echo "gcloud configured for emulator at $PUBSUB_EMULATOR_HOST project $(gcloud config get-value project)"
          # echo "Credential checks disabled: $(gcloud config get-value auth/disable_credentials)" # Also remove this verification line

          echo "Create Test Topic"
          echo "======"
          
          echo "Attempting to create topic 'my-test-topic'..."
          gcloud pubsub topics create my-test-topic
          echo "Topic created successfully."

          echo "Publish Text Message"
          echo "======"
          echo "Publishing text message..."
          gcloud pubsub topics publish my-test-topic --message "Hello from GitHub Actions using Pub/Sub Emulator!"
          echo "Text message published."

          echo "Publish JSON Message"
          echo "======"

          echo "Publishing JSON message..."
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          MESSAGE_JSON="{\"id\": \"workflow-${{ github.run_id }}\", \"status\": \"testing\", \"timestamp\": \"${TIMESTAMP}\"}"
          echo "Publishing: ${MESSAGE_JSON}"
          gcloud pubsub topics publish my-test-topic --message "${MESSAGE_JSON}"
          echo "JSON message published."

          echo "Verify Topics"
          echo "======"

          echo "Verifying topics..."
          gcloud pubsub topics list
    